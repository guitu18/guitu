package com.guitu18.http;

import com.guitu18.common.Constants;
import io.netty.handler.codec.http.FullHttpRequest;
import io.netty.handler.codec.http.cookie.Cookie;
import io.netty.handler.codec.http.cookie.ServerCookieDecoder;
import lombok.Data;

import java.util.HashMap;
import java.util.Map;
import java.util.Set;

/**
 * Request
 *
 * @author zhangkuan
 * @date 2019/8/19
 */
@Data
public class Request {

    private String httpVersion;

    private String uri;

    private String method;

    private Map<String, String> headers = new HashMap<>();

    private Map<String, Cookie> cookies = new HashMap<>();

    /**
     * 包装Request信息
     *
     * @param request
     */
    public Request(FullHttpRequest request) {
        this.httpVersion = request.protocolVersion().toString();
        this.uri = request.uri();
        this.method = request.method().name();
        parseHeaders(request);
    }


    /**
     * 解析Header
     *
     * @param request
     */
    private void parseHeaders(FullHttpRequest request) {
        for (Map.Entry<String, String> header : request.headers()) {
            String key = header.getKey();
            String value = header.getValue();
            headers.put(key, value);
            // 解析Cookie
            if (Constants.ContentType.COOKIE.equals(key)) {
                Set<Cookie> cookies = ServerCookieDecoder.LAX.decode(value);
                for (Cookie cookie : cookies) {
                    this.cookies.put(cookie.name(), cookie);
                }
            }
        }
    }

}
